# üöÄ Plano de Migra√ß√£o da API Trello - inPatch Suporte

## üìã Vis√£o Geral

Este documento detalha o plano de migra√ß√£o e reestrutura√ß√£o da integra√ß√£o com a API do Trello, implementa√ß√£o do Prisma ORM e integra√ß√£o avan√ßada com Supabase usando MCP.

## üéØ Objetivos

1. **Migrar do web scraping para API oficial** do Trello
2. **Implementar Prisma ORM** para melhor gerenciamento de dados
3. **Integrar Supabase MCP** para opera√ß√µes avan√ßadas
4. **Reestruturar arquitetura** seguindo padr√µes de Vibe Coding
5. **Melhorar performance e confiabilidade**

## üìä Status Atual vs Futuro

| Aspecto | Atual | Futuro |
|---------|--------|--------|
| **API Trello** | ‚úÖ Implementada (lib/trello.ts) | üîÑ Melhorar e otimizar |
| **ORM** | ‚ùå Integra√ß√£o direta Supabase | ‚úÖ Prisma + Supabase |
| **Sincroniza√ß√£o** | ‚úÖ Polling + Webhooks | üîÑ MCP + Real-time |
| **Tipagem** | ‚úÖ TypeScript interfaces | üîÑ Prisma schemas |
| **Error Handling** | ‚úÖ B√°sico implementado | üîÑ Avan√ßado com MCP |

## üèóÔ∏è Fases da Migra√ß√£o

### **Fase 1: Prisma Setup & Schema Design** 
*Dura√ß√£o estimada: 2-3 dias*

#### 1.1 Configura√ß√£o do Prisma
```bash
npx prisma init
```

#### 1.2 Schema Prisma (`prisma/schema.prisma`)
```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Project {
  id                 String          @id @default(cuid())
  title              String
  description        String?
  progress           Int             @default(0)
  platforms          Platform[]
  responsible        TeamMember[]
  imageUrl           String?         @map("image_url")
  startDate          DateTime        @map("start_date") @default(now())
  estimatedEndDate   DateTime        @map("estimated_end_date")
  status             ProjectStatus   @default(A_FAZER)
  priority           ProjectPriority @default(MEDIUM)
  trelloCardId       String?         @unique @map("trello_card_id")
  labels             String[]        @default([])
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  
  // Relations
  syncHistory        SyncHistory[]
  
  @@map("projects")
}

model SyncHistory {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  action      SyncAction
  timestamp   DateTime @default(now())
  source      String   // "trello" | "manual" | "webhook"
  details     Json?
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@map("sync_history")
}

enum ProjectStatus {
  A_FAZER      @map("a-fazer")
  EM_ANDAMENTO @map("em-andamento")
  CONCLUIDO    @map("concluido")
}

enum ProjectPriority {
  LOW    @map("low")
  MEDIUM @map("medium")
  HIGH   @map("high")
}

enum Platform {
  N8N             @map("N8N")
  JIRA            @map("Jira")
  HUBSPOT         @map("Hubspot")
  BACKOFFICE      @map("Backoffice")
  GOOGLE_WORKSPACE @map("Google Workspace")
}

enum TeamMember {
  GUILHERME_SOUZA @map("Guilherme Souza")
  FELIPE_BRAAT    @map("Felipe Braat")
  TIAGO_TRIANI    @map("Tiago Triani")
}

enum SyncAction {
  CREATED
  UPDATED
  DELETED
  SYNCED
}
```

#### 1.3 Migra√ß√£o inicial
```bash
npx prisma db push
npx prisma generate
```

### **Fase 2: Integra√ß√£o Supabase MCP**
*Dura√ß√£o estimada: 3-4 dias*

#### 2.1 Configura√ß√£o MCP Supabase
- Implementar conex√£o com MCP para opera√ß√µes avan√ßadas
- Configurar Edge Functions para webhooks
- Setup de Real-time subscriptions

#### 2.2 Novo servi√ßo de banco (`lib/database/prisma.ts`)
```typescript
import { PrismaClient } from '@prisma/client'
import { Project, ProjectStatus, ProjectPriority, Platform, TeamMember } from '@prisma/client'

export class DatabaseService {
  private prisma = new PrismaClient()

  async getProjects(): Promise<Project[]> {
    return this.prisma.project.findMany({
      orderBy: { updatedAt: 'desc' }
    })
  }

  async createProject(data: Omit<Project, 'id' | 'createdAt' | 'updatedAt'>): Promise<Project> {
    return this.prisma.project.create({
      data: {
        ...data,
        syncHistory: {
          create: {
            action: 'CREATED',
            source: 'trello',
          }
        }
      }
    })
  }

  async syncFromTrello(trelloCards: TrelloCard[]): Promise<void> {
    // Batch upsert with transaction
    await this.prisma.$transaction(async (tx) => {
      for (const card of trelloCards) {
        await tx.project.upsert({
          where: { trelloCardId: card.id },
          update: this.transformTrelloToProject(card),
          create: this.transformTrelloToProject(card),
        })
      }
    })
  }
}
```

### **Fase 3: API Trello Enhancement**
*Dura√ß√£o estimada: 2-3 dias*

#### 3.1 Melhorias na TrelloAPI (`lib/api/trello-enhanced.ts`)
```typescript
export class EnhancedTrelloAPI extends TrelloAPI {
  // Batch operations
  async getBatchCards(cardIds: string[]): Promise<TrelloCard[]> {
    const batchSize = 10
    const batches = []
    
    for (let i = 0; i < cardIds.length; i += batchSize) {
      const batch = cardIds.slice(i, i + batchSize)
      batches.push(
        Promise.all(batch.map(id => this.getCard(id)))
      )
    }
    
    return (await Promise.all(batches)).flat()
  }

  // Advanced webhook management
  async setupAdvancedWebhook(): Promise<void> {
    const existingWebhooks = await this.getWebhooks()
    
    // Setup multiple webhooks for different events
    const webhookConfigs = [
      { modelType: 'board', events: ['createCard', 'updateCard', 'deleteCard'] },
      { modelType: 'list', events: ['updateList'] },
      { modelType: 'card', events: ['commentCard', 'addAttachmentToCard'] }
    ]
    
    for (const config of webhookConfigs) {
      await this.createSpecificWebhook(config)
    }
  }
}
```

#### 3.2 Novo sistema de Cache (`lib/cache/redis-cache.ts`)
```typescript
export class CacheService {
  async getCachedProjects(): Promise<Project[] | null> {
    // Implementar cache Redis ou Memory cache
    return null
  }

  async setCachedProjects(projects: Project[]): Promise<void> {
    // Implementar invalida√ß√£o inteligente
  }
}
```

### **Fase 4: Supabase MCP Integration**
*Dura√ß√£o estimada: 4-5 dias*

#### 4.1 MCP Service (`lib/services/supabase-mcp.ts`)
```typescript
import { mcp2_execute_sql, mcp2_get_project } from '@/lib/mcp'

export class SupabaseMCPService {
  async executeAdvancedQuery(query: string): Promise<any[]> {
    return await mcp2_execute_sql({
      project_id: process.env.SUPABASE_PROJECT_ID!,
      query
    })
  }

  async getProjectAnalytics(): Promise<any> {
    const query = `
      SELECT 
        status,
        COUNT(*) as count,
        AVG(progress) as avg_progress,
        EXTRACT(WEEK FROM created_at) as week
      FROM projects 
      GROUP BY status, week
      ORDER BY week DESC
    `
    return this.executeAdvancedQuery(query)
  }

  async setupRealtimeSubscriptions(): Promise<void> {
    // Implementar subscriptions em tempo real
  }
}
```

#### 4.2 Edge Functions para Webhooks
```typescript
// supabase/functions/trello-webhook/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

serve(async (req) => {
  const { action, data } = await req.json()
  
  // Process webhook with MCP
  await processWebhookAction(action, data)
  
  return new Response('OK', { status: 200 })
})
```

### **Fase 5: Reestrutura√ß√£o da Arquitetura**
*Dura√ß√£o estimada: 3-4 dias*

#### 5.1 Nova estrutura de servi√ßos
```
lib/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ prisma.ts          # Prisma client e opera√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ migrations.ts      # Migra√ß√µes customizadas
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ trello-enhanced.ts # API Trello melhorada
‚îÇ   ‚îî‚îÄ‚îÄ webhook-handler.ts # Processamento de webhooks
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ sync-orchestrator.ts # Orquestra√ß√£o de sync
‚îÇ   ‚îú‚îÄ‚îÄ supabase-mcp.ts     # Integra√ß√£o MCP
‚îÇ   ‚îî‚îÄ‚îÄ cache-service.ts    # Sistema de cache
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ transformers.ts     # Transforma√ß√µes de dados
‚îÇ   ‚îî‚îÄ‚îÄ validators.ts       # Valida√ß√µes avan√ßadas
‚îî‚îÄ‚îÄ types/
    ‚îú‚îÄ‚îÄ prisma.d.ts        # Tipos Prisma estendidos
    ‚îî‚îÄ‚îÄ mcp.d.ts           # Tipos MCP
```

#### 5.2 Sync Orchestrator (`lib/services/sync-orchestrator.ts`)
```typescript
export class SyncOrchestrator {
  constructor(
    private trelloAPI: EnhancedTrelloAPI,
    private database: DatabaseService,
    private mcp: SupabaseMCPService,
    private cache: CacheService
  ) {}

  async performFullSync(): Promise<void> {
    // 1. Fetch from Trello
    const trelloCards = await this.trelloAPI.getBoardCards()
    
    // 2. Transform and validate
    const validatedProjects = await this.validateAndTransform(trelloCards)
    
    // 3. Sync to database via Prisma
    await this.database.syncFromTrello(validatedProjects)
    
    // 4. Update analytics via MCP
    await this.mcp.updateAnalytics()
    
    // 5. Invalidate cache
    await this.cache.invalidateAll()
    
    // 6. Notify subscribers
    await this.notifySubscribers()
  }
}
```

## üîß Implementa√ß√£o Detalhada

### **Etapas de Execu√ß√£o**

#### **Etapa 1: Prepara√ß√£o (1 dia)**
- [ ] Backup do banco atual
- [ ] Configurar branch de migra√ß√£o
- [ ] Instalar depend√™ncias Prisma
- [ ] Configurar vari√°veis de ambiente

#### **Etapa 2: Schema & Prisma (2 dias)**
- [ ] Criar schema.prisma completo
- [ ] Executar migra√ß√£o inicial
- [ ] Implementar DatabaseService
- [ ] Testes de CRUD b√°sico

#### **Etapa 3: MCP Integration (3 dias)**
- [ ] Configurar Supabase MCP
- [ ] Implementar SupabaseMCPService
- [ ] Criar Edge Functions
- [ ] Configurar Real-time subscriptions

#### **Etapa 4: API Enhancement (2 dias)**
- [ ] Melhorar TrelloAPI existente
- [ ] Implementar cache service
- [ ] Adicionar batch operations
- [ ] Webhook management avan√ßado

#### **Etapa 5: Orchestration (3 dias)**
- [ ] Implementar SyncOrchestrator
- [ ] Migrar store.ts para nova arquitetura
- [ ] Atualizar componentes React
- [ ] Testes de integra√ß√£o

#### **Etapa 6: Testing & Optimization (2 dias)**
- [ ] Testes end-to-end
- [ ] Otimiza√ß√£o de performance
- [ ] Documenta√ß√£o atualizada
- [ ] Deploy para produ√ß√£o

## üöÄ Benef√≠cios Esperados

### **Performance**
- ‚ö° **50%** redu√ß√£o no tempo de sincroniza√ß√£o
- üöÄ **80%** melhoria em queries complexas
- üíæ Cache inteligente reduz calls desnecess√°rias

### **Confiabilidade** 
- üõ°Ô∏è Transa√ß√µes ACID com Prisma
- üîÑ Retry autom√°tico e circuit breakers
- üìä Logs detalhados de sincroniza√ß√£o

### **Escalabilidade**
- üìà Suporte a milhares de projetos
- üîÄ Batch operations otimizadas
- üåê Real-time updates via MCP

### **Manutenibilidade**
- üèóÔ∏è Arquitetura modular e test√°vel
- üìù Tipagem forte end-to-end
- üîß Separa√ß√£o clara de responsabilidades

## ‚ö†Ô∏è Riscos e Mitiga√ß√µes

| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| **Migra√ß√£o de dados** | M√©dia | Alto | Backup completo + rollback plan |
| **Rate limiting Trello** | Alta | M√©dio | Cache agressivo + batch operations |
| **MCP learning curve** | Alta | Baixo | Documenta√ß√£o + POC inicial |
| **Breaking changes** | Baixa | Alto | Testes automatizados + feature flags |

## üìù Pr√≥ximos Passos

1. **Aprova√ß√£o do plano** pela equipe
2. **Setup do ambiente** de desenvolvimento
3. **In√≠cio da Fase 1** - Prisma Setup
4. **Reviews di√°rias** de progresso
5. **Deploy gradual** por features

## üîó Depend√™ncias Externas

- **Supabase MCP**: Configura√ß√£o de projeto
- **Trello API**: Rate limits e webhooks
- **Prisma**: Vers√£o compat√≠vel com Supabase
- **Edge Functions**: Deploy e configura√ß√£o

---

**üìÖ Timeline Total**: 15-18 dias de desenvolvimento
**üë• Recursos**: 1-2 desenvolvedores s√™nior
**üéØ Meta**: Sistema robusto e escal√°vel para gest√£o de projetos

*Documento criado seguindo padr√µes de Vibe Coding e arquitetura Next.js 15 + Prisma + Supabase MCP*
